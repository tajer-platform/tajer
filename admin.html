<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | Ø¥Ø¯Ø§Ø±Ù€Ø© ØªÙ€Ø§Ø¬Ù€Ø±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --bg: #f1f5f9;
            --sidebar: #0f172a;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text: #334155;
            --radius: 10px;
        }

        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 25px; font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); letter-spacing: 1px; }
        .sidebar-header span { color: var(--primary); }
        
        .nav { padding: 20px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .nav button { 
            background: transparent; border: none; color: #94a3b8; padding: 12px 15px; 
            border-radius: var(--radius); text-align: right; cursor: pointer;
            display: flex; gap: 12px; align-items: center; transition: 0.3s; font-size: 0.95rem;
        }
        .nav button:hover, .nav button.active { background: var(--primary); color: white; transform: translateX(-5px); }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .tab { display: none; animation: fadeIn 0.4s ease-in-out; }
        .tab.active { display: block; }

        /* Cards & Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-right: 4px solid var(--primary); }
        .stat-card h3 { margin: 0 0 10px 0; color: #64748b; font-size: 0.9rem; }
        .stat-card .val { font-size: 2rem; font-weight: 800; color: var(--text); }
        .stat-card i { float: left; font-size: 2rem; opacity: 0.1; }

        /* Tables & Lists */
        .section { background: white; padding: 25px; border-radius: var(--radius); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; padding: 15px; background: #f8fafc; color: #475569; font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; vertical-align: middle; }
        
        /* Inputs & Buttons */
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; flex: 1; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { filter: brightness(110%); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* Badge Status */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-success { background: #dcfce7; color: #166534; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .sidebar { width: 100%; }
            .nav { flex-direction: row; flex-wrap: nowrap; overflow-x: auto; }
            .nav button { white-space: nowrap; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header"><i class="fas fa-chart-line"></i> ØªÙ€Ø§Ø¬Ø± <span>Admin</span></div>
    <div class="nav">
        <button class="active" onclick="openTab('dashboard',this)"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button onclick="openTab('users',this)"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ†</button>
        <button onclick="openTab('market',this)"><i class="fas fa-store"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙˆÙ‚</button>
        <button onclick="openTab('withdrawals',this)"><i class="fas fa-money-bill-wave"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</button>
        <button onclick="openTab('profits',this)"><i class="fas fa-hand-holding-usd"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</button>
        <button onclick="openTab('logs',this)"><i class="fas fa-list"></i> Ø§Ù„Ø³Ø¬Ù„</button>
    </div>
</div>

<div class="main">

    <div id="dashboard" class="tab active">
        <div class="grid">
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ†</h3>
                <span class="val" id="d-users">0</span>
            </div>
            <div class="stat-card" style="border-color: var(--success)">
                <i class="fas fa-coins"></i>
                <h3>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±</h3>
                <span class="val" id="d-capital">0</span> <small>Ù„.Ø³</small>
            </div>
            <div class="stat-card" style="border-color: var(--warning)">
                <i class="fas fa-money-bill"></i>
                <h3>Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
                <span class="val" id="d-pending">0</span>
            </div>
        </div>
    </div>

    <div id="users" class="tab">
        <div class="section">
            <div class="section-header">
                <h2>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ†</h2>
                <button class="btn btn-primary" onclick="showAddUser()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ</button>
            </div>
            <table id="usersTable">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯ (Ù„.Ø³)</th><th>Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ©</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                <tbody><tr><td colspan="4" style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="market" class="tab">
        <div class="section">
            <div class="section-header">
                <h2>ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</h2>
            </div>
            <div class="input-group" style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø«Ø§Ù„: Ø¯Ø¬Ø§Ø¬Ø© Ø¨ÙŠØ§Ø¶Ø©)">
                <input type="number" id="pPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
                <input type="number" id="pReturn" placeholder="Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹">
                <button class="btn btn-success" onclick="addProduct()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³ÙˆÙ‚</button>
            </div>
            <table id="marketTable">
                <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="withdrawals" class="tab">
        <div class="section">
            <div class="section-header">
                <h2>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
            </div>
            <table id="withdrawalsTable">
                <thead><tr><th>Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="profits" class="tab">
        <div class="section" style="max-width: 600px; margin: 0 auto; text-align: center;">
            <i class="fas fa-gift" style="font-size: 3rem; color: var(--gold); margin-bottom: 20px;"></i>
            <h2>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¯ÙˆØ±ÙŠØ©</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ. <br>
                <b style="color: var(--danger)">ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ²ÙŠØ¯ Ø£Ø±ØµØ¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</b>
            </p>
            <input type="number" id="profitInput" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ø«Ø§Ù„: 5,000,000)" style="font-size: 1.2rem; text-align: center;">
            <br><br>
            <button class="btn btn-primary" style="width: 100%; padding: 15px;" onclick="distribute()">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
        </div>
    </div>

    <div id="logs" class="tab">
        <div class="section">
            <h2>ğŸ“œ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
            <div id="logBox" style="font-family: monospace; color: #444; white-space: pre-line; max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

</div>

<script type="module">
    // 1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, increment, serverTimestamp, onSnapshot, query, orderBy, where } 
    from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
    const firebaseConfig = {
        apiKey: "AIzaSyCI_0-7KsqnssqkOSkNVK0FmuRokDNXriE",
        authDomain: "tajer-app-e1b97.firebaseapp.com",
        projectId: "tajer-app-e1b97",
        storageBucket: "tajer-app-e1b97.firebasestorage.app",
        messagingSenderId: "92669858022",
        appId: "1:92669858022:web:a1223e9121190815066b27"
    };

    // 3. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Ø§Ù„ØªØ±ØªÙŠØ¨ Ù‡Ù†Ø§ Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹)
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 4. ÙƒÙˆØ¯ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ØŒ ØªÙˆØ¬Ù‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            window.location.href = "admin-login.html";
        } else {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ù‡Ùˆ Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø§Ø¯Ù…Ù† ÙÙ‚Ø·
            if(user.email !== "admin@tajer.com") { 
                alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø©");
                signOut(auth);
            }
        }
    });

    /* ===========================
       1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (UI)
       =========================== */
    window.openTab = (id, btn) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    };

    /* ===========================
       2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ† (Users)
       =========================== */
    onSnapshot(collection(db, "users"), (snap) => {
        let rows = "";
        let totalCapital = 0;
        let userCount = 0;

        snap.forEach(d => {
            const u = d.data();
            const id = d.id;
            userCount++;
            let assetsCount = u.assets ? u.assets.length : 0;
            totalCapital += (u.balance || 0); 

            rows += `
            <tr>
                <td>
                    <div style="font-weight:bold">${u.name || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯'}</div>
                    <small style="color:#aaa">${id}</small>
                </td>
                <td style="color:var(--success); font-weight:bold">${(u.balance || 0).toLocaleString()} Ù„.Ø³</td>
                <td><span class="badge badge-success">${assetsCount} Ø£ØµÙ„</span></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editBalance('${id}')"><i class="fas fa-edit"></i> Ø±ØµÙŠØ¯</button>
                    <button class="btn btn-danger btn-sm" onclick="delUser('${id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });

        document.getElementById("usersTable").querySelector("tbody").innerHTML = rows || "<tr><td colspan='4'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ†</td></tr>";
        document.getElementById("d-users").innerText = userCount;
        document.getElementById("d-capital").innerText = totalCapital.toLocaleString();
    });

    window.showAddUser = async () => {
        const name = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø³ØªØ«Ù…Ø±:");
        if(!name) return;
        await addDoc(collection(db, "users"), {
            name: name, balance: 0, assets: [], createdAt: serverTimestamp()
        });
        logAction(`Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: ${name}`);
    };

    window.delUser = async (id) => {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!")) {
            await deleteDoc(doc(db, "users", id));
            logAction(`Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… ID: ${id}`);
        }
    };

    window.editBalance = async (id) => {
        const amount = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡ (Ø£Ùˆ Ø±Ù‚Ù… Ø³Ø§Ù„Ø¨ Ù„Ù„Ø®ØµÙ…):");
        if(amount) {
            await updateDoc(doc(db, "users", id), {
                balance: increment(parseInt(amount))
            });
            logAction(`ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… ${id} Ø¨Ù…Ù‚Ø¯Ø§Ø± ${amount}`);
        }
    };

    /* ===========================
       3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙˆÙ‚ (Market)
       =========================== */
    onSnapshot(collection(db, "market_items"), (snap) => {
        let rows = "";
        snap.forEach(d => {
            const p = d.data();
            rows += `
            <tr>
                <td>${p.name}</td>
                <td>${p.price.toLocaleString()} Ù„.Ø³</td>
                <td>${p.returnRate || 0}</td>
                <td><button class="btn btn-danger btn-sm" onclick="delProduct('${d.id}')">Ø­Ø°Ù</button></td>
            </tr>`;
        });
        document.getElementById("marketTable").querySelector("tbody").innerHTML = rows;
    });

    window.addProduct = async () => {
        const name = document.getElementById("pName").value;
        const price = Number(document.getElementById("pPrice").value);
        const ret = document.getElementById("pReturn").value;

        if(!name || !price) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        await addDoc(collection(db, "market_items"), {
            name: name, price: price, returnRate: ret, createdAt: serverTimestamp()
        });
        
        document.getElementById("pName").value = "";
        document.getElementById("pPrice").value = "";
        logAction(`Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³ÙˆÙ‚: ${name}`);
    };

    window.delProduct = async (id) => {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚ØŸ")) {
            await deleteDoc(doc(db, "market_items", id));
            logAction(`Ø­Ø°Ù Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚`);
        }
    };

    /* ===========================
       4. Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (Withdrawals)
       =========================== */
    onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), (snap) => {
        let rows = "";
        document.getElementById("d-pending").innerText = snap.size;

        snap.forEach(d => {
            const w = d.data();
            rows += `
            <tr>
                <td>${w.userName || 'Ù…Ø¬Ù‡ÙˆÙ„'}</td>
                <td style="font-weight:bold">${w.amount.toLocaleString()} Ù„.Ø³</td>
                <td><span class="badge badge-pending">Ù…Ø¹Ù„Ù‚</span></td>
                <td>
                    <button class="btn btn-success btn-sm" onclick="approveWithdraw('${d.id}', '${w.userId}', ${w.amount})">âœ” Ù‚Ø¨ÙˆÙ„</button>
                    <button class="btn btn-danger btn-sm" onclick="rejectWithdraw('${d.id}')">âœ– Ø±ÙØ¶</button>
                </td>
            </tr>`;
        });
        document.getElementById("withdrawalsTable").querySelector("tbody").innerHTML = rows || "<tr><td colspan='4'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</td></tr>";
    });

    window.approveWithdraw = async (reqId, userId, amount) => {
        if(!confirm("ØªØ£ÙƒÙŠØ¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„ØºØŸ")) return;
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø±ØµÙŠØ¯ ÙŠÙØ®ØµÙ… Ø¹Ø§Ø¯Ø© Ø¹Ù†Ø¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ©
        await updateDoc(doc(db, "withdrawals", reqId), {
            status: "approved",
            approvedAt: serverTimestamp()
        });
        logAction(`Ù‚Ø¨ÙˆÙ„ Ø³Ø­Ø¨ Ø¨Ù…Ø¨Ù„Øº ${amount} Ù„Ù€ ${userId}`);
    };

    window.rejectWithdraw = async (reqId) => {
        if(!confirm("Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;
        // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ØªÙ… Ø®ØµÙ…Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        await updateDoc(doc(db, "withdrawals", reqId), { status: "rejected" });
        logAction(`Ø±ÙØ¶ Ø·Ù„Ø¨ Ø³Ø­Ø¨`);
    };

    /* ===========================
       5. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Distribution)
       =========================== */
    window.distribute = async () => {
        const amount = parseFloat(document.getElementById("profitInput").value);
        if(!amount || amount <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
        
        const btn = document.querySelector("#profits button");
        btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹...";

        try {
            const snap = await getDocs(collection(db, "users"));
            let totalShares = 0;
            
            snap.forEach(d => {
                const u = d.data();
                if(u.assets) totalShares += u.assets.length;
            });

            if(totalShares === 0) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ù…Ù…Ù„ÙˆÙƒØ© Ø­Ø§Ù„ÙŠØ§Ù‹!");

            const perShare = amount / totalShares;

            const batchPromises = snap.docs.map(userDoc => {
                const u = userDoc.data();
                const shares = u.assets ? u.assets.length : 0;
                if(shares > 0) {
                    const profit = Math.floor(shares * perShare);
                    return updateDoc(doc(db, "users", userDoc.id), {
                        balance: increment(profit)
                    });
                }
            });

            await Promise.all(batchPromises);
            logAction(`ØªÙˆØ²ÙŠØ¹ Ø£Ø±Ø¨Ø§Ø­ Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${amount} Ù„.Ø³`);
            alert("ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
            document.getElementById("profitInput").value = "";

        } catch(e) {
            alert("ÙØ´Ù„ Ø§Ù„ØªÙˆØ²ÙŠØ¹: " + e.message);
        }
        
        btn.disabled = false; btn.innerText = "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹";
    };

    /* ===========================
       6. Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Logs)
       =========================== */
    async function logAction(text) {
        await addDoc(collection(db, "logs"), {
            text: text,
            timestamp: serverTimestamp()
        });
    }

    onSnapshot(query(collection(db, "logs"), orderBy("timestamp", "desc")), (snap) => {
        const box = document.getElementById("logBox");
        if(!box) return;
        box.innerHTML = "";
        snap.forEach(d => {
            const l = d.data();
            const time = l.timestamp ? l.timestamp.toDate().toLocaleString('ar-SY') : "Ø§Ù„Ø¢Ù†";
            box.innerHTML += `[${time}] ${l.text}\n----------------\n`;
        });
    });

    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    window.logout = () => {
        signOut(auth).then(() => window.location.href = "admin-login.html");
    };

</script>
</body>
</html>