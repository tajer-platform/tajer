<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ€Ø§Ø¬Ø± Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ | Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #10b981; --primary-dark: #059669;
            --secondary: #3b82f6; --accent: #f59e0b;
            --bg-body: #f1f5f9; --white: #ffffff;
            --text-main: #1e293b; --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); padding-bottom: 90px; direction: rtl; }

        /* --- Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #064e3b, #0f172a);
            z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(15px);
            padding: 30px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2);
            width: 100%; max-width: 400px; color: white; text-align: center;
        }
        .auth-input {
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px;
            border: none; outline: none; font-size: 1rem; text-align: center;
        }
        .btn-auth {
            background: var(--primary); color: white; border: none; padding: 14px;
            width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 15px;
        }
        .switch-auth { margin-top: 20px; font-size: 0.9rem; cursor: pointer; text-decoration: underline; opacity: 0.8; }

        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        .top-bar {
            background: linear-gradient(135deg, #064e3b 0%, #10b981 100%);
            color: white; padding: 20px 25px 40px; border-radius: 0 0 30px 30px; box-shadow: var(--shadow);
            position: sticky; top: 0; z-index: 100;
        }
        .balance-float {
            background: var(--white); width: 90%; margin: -30px auto 0;
            padding: 20px; border-radius: 20px; box-shadow: var(--shadow);
            display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 101;
        }
        .page { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .market-item {
            background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow);
        }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: var(--glass);
            backdrop-filter: blur(10px); padding: 15px; display: flex; justify-content: space-around;
            border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item { text-align: center; color: #94a3b8; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 12px 25px; border-radius: 50px;
            z-index: 11000; display: none;
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="auth-overlay">
        <div class="auth-box" id="login-section">
            <i class="fas fa-user-circle" style="font-size: 3.5rem; color: var(--primary); margin-bottom: 15px;"></i>
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p style="margin-bottom: 20px; opacity: 0.8;">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <input type="tel" id="loginPhone" class="auth-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
            <button class="btn-auth" onclick="handleAuth('login')">Ø¯Ø®ÙˆÙ„ <i class="fas fa-sign-in-alt"></i></button>
            <div class="switch-auth" onclick="toggleAuth(false)">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</div>
        </div>

        <div class="auth-box" id="register-section" style="display: none;">
            <i class="fas fa-user-plus" style="font-size: 3.5rem; color: var(--secondary); margin-bottom: 15px;"></i>
            <h2>Ù…Ø³ØªØ«Ù…Ø± Ø¬Ø¯ÙŠØ¯</h2>
            <p style="margin-bottom: 20px; opacity: 0.8;">Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø¹Ø§Ø¦Ù„Ø© ØªØ§Ø¬Ø± Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ</p>
            <input type="text" id="regName" class="auth-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="email" id="regEmail" class="auth-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="tel" id="regPhone" class="auth-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
            <button class="btn-auth" style="background: var(--secondary);" onclick="handleAuth('register')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            <div class="switch-auth" onclick="toggleAuth(true)">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <header class="top-bar">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="font-size: 1rem; opacity: 0.9;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ</h3>
                    <h1 id="userNameDisplay" style="font-size: 1.4rem;">...</h1>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                    <i class="fas fa-bell"></i>
                </div>
            </div>
        </header>

        <div class="balance-float">
            <div>
                <div style="font-size: 0.8rem; color: #64748b;">Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
                <div style="font-size: 1.3rem; font-weight: 800;"><span id="userBalanceDisplay">0</span> <small>Ù„.Ø³</small></div>
            </div>
            <button onclick="openTab('wallet')" style="background: #ecfdf5; border:none; padding:10px; border-radius:10px; color: var(--primary);">
                <i class="fas fa-plus"></i> Ø´Ø­Ù†
            </button>
        </div>

        <main>
            <section id="home" class="page active">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <div style="background:white; padding:15px; border-radius:15px; text-align:center;">
                        <i class="fas fa-chart-pie" style="color:var(--primary); font-size:1.5rem;"></i>
                        <div style="font-size:0.7rem; color:#64748b;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…</div>
                        <div id="userSharesCount" style="font-weight:bold;">0</div>
                    </div>
                    <div style="background:white; padding:15px; border-radius:15px; text-align:center;">
                        <i class="fas fa-wallet" style="color:var(--secondary); font-size:1.5rem;"></i>
                        <div style="font-size:0.7rem; color:#64748b;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</div>
                        <div id="userAssetsValue" style="font-weight:bold;">0</div>
                    </div>
                </div>
            </section>

            <section id="market" class="page">
                <h3 style="margin-bottom:15px;">Ø§Ù„ÙØ±Øµ Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                <div id="marketList"></div>
            </section>

            <section id="wallet" class="page">
                <h3>Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø£Ø±Ø¨Ø§Ø­</h3>
                <div style="background:white; padding:20px; border-radius:20px; margin-top:15px;">
                    <input type="number" id="withdrawAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; margin-bottom:15px;">
                    <button class="btn-auth" onclick="requestWithdraw()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="openTab('home', this)"><i class="fas fa-home"></i><br><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
            <div class="nav-item" onclick="openTab('market', this)"><i class="fas fa-store"></i><br><span>Ø§Ù„Ø³ÙˆÙ‚</span></div>
            <div class="nav-item" onclick="openTab('wallet', this)"><i class="fas fa-wallet"></i><br><span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span></div>
            <div class="nav-item" onclick="logout()" style="color:#f87171;"><i class="fas fa-sign-out-alt"></i><br><span>Ø®Ø±ÙˆØ¬</span></div>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getFirestore, collection, query, where, getDocs, addDoc, doc, onSnapshot, 
            serverTimestamp, runTransaction 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCI_0-7KsqnssqkOSkNVK0FmuRokDNXriE",
            authDomain: "tajer-app-e1b97.firebaseapp.com",
            projectId: "tajer-app-e1b97",
            storageBucket: "tajer-app-e1b97.firebasestorage.app",
            messagingSenderId: "92669858022",
            appId: "1:92669858022:web:a1223e9121190815066b27"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let userDocId = localStorage.getItem('tajer_uid');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
        if (userDocId) {
            startApp(userDocId);
        }

        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
        window.toggleAuth = (showLogin) => {
            document.getElementById('login-section').style.display = showLogin ? 'block' : 'none';
            document.getElementById('register-section').style.display = showLogin ? 'none' : 'block';
        };

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        window.handleAuth = async (type) => {
            if (type === 'login') {
                const phone = document.getElementById('loginPhone').value.trim();
                if (!phone) return showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
                
                const q = query(collection(db, "users"), where("phone", "==", phone));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    showToast("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨");
                } else {
                    loginSuccess(snap.docs[0].id);
                }
            } else {
                const name = document.getElementById('regName').value.trim();
                const email = document.getElementById('regEmail').value.trim();
                const phone = document.getElementById('regPhone').value.trim();

                if (!name || !phone) return showToast("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ù…Ø·Ù„ÙˆØ¨Ø§Ù†");

                // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…
                const q = query(collection(db, "users"), where("phone", "==", phone));
                const check = await getDocs(q);
                if (!check.empty) return showToast("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹");

                const newUser = await addDoc(collection(db, "users"), {
                    name, email, phone,
                    balance: 0,
                    assets: [],
                    createdAt: serverTimestamp()
                });
                loginSuccess(newUser.id);
            }
        };

        function loginSuccess(id) {
            localStorage.setItem('tajer_uid', id);
            userDocId = id;
            startApp(id);
        }

        function startApp(id) {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø­Ø¸ÙŠØ§Ù‹
            onSnapshot(doc(db, "users", id), (snap) => {
                if (snap.exists()) {
                    currentUser = snap.data();
                    document.getElementById('userNameDisplay').innerText = currentUser.name;
                    document.getElementById('userBalanceDisplay').innerText = Number(currentUser.balance).toLocaleString();
                    document.getElementById('userSharesCount').innerText = (currentUser.assets || []).length;
                    
                    const totalValue = (currentUser.assets || []).reduce((sum, a) => sum + Number(a.priceAtPurchase), 0);
                    document.getElementById('userAssetsValue').innerText = totalValue.toLocaleString() + " Ù„.Ø³";
                }
            });

            loadMarket();
        }

        function loadMarket() {
            onSnapshot(collection(db, "market_items"), (snap) => {
                const list = document.getElementById('marketList');
                list.innerHTML = '';
                snap.forEach(d => {
                    const item = d.data();
                    list.innerHTML += `
                        <div class="market-item">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${item.name}</strong>
                                <span style="color:var(--primary); font-weight:800;">${item.price.toLocaleString()} Ù„.Ø³</span>
                            </div>
                            <p style="font-size:0.8rem; color:#64748b; margin-top:5px;">Ø¹Ø§Ø¦Ø¯ Ù…ØªÙˆÙ‚Ø¹: ${item.returnRate}%</p>
                            <button class="btn-auth" onclick="buyItem('${d.id}', '${item.name}', ${item.price})" 
                                ${item.quantity <= 0 ? 'disabled style="background:#ccc"' : ''}>
                                ${item.quantity <= 0 ? 'Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©' : 'Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø¢Ù†'}
                            </button>
                        </div>
                    `;
                });
            });
        }

        window.buyItem = async (itemId, name, price) => {
            if (currentUser.balance < price) return showToast("Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ");
            if (!confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªØ«Ù…Ø§Ø± Ù…Ø¨Ù„Øº ${price} Ù„.Ø³ ÙÙŠ ${name}ØŸ`)) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const mRef = doc(db, "market_items", itemId);
                    const uRef = doc(db, "users", userDocId);
                    
                    const mDoc = await transaction.get(mRef);
                    const uDoc = await transaction.get(uRef);
                    
                    if (mDoc.data().quantity <= 0) throw "Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©";
                    
                    transaction.update(mRef, { quantity: mDoc.data().quantity - 1 });
                    
                    const newAssets = uDoc.data().assets || [];
                    newAssets.push({ name, priceAtPurchase: price, date: new Date().toISOString() });
                    
                    transaction.update(uRef, {
                        balance: uDoc.data().balance - price,
                        assets: newAssets
                    });
                });
                showToast("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰");
            } catch (e) { showToast(e); }
        };

        window.requestWithdraw = async () => {
            const amt = Number(document.getElementById('withdrawAmt').value);
            if (!amt || amt <= 0) return showToast("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹");
            if (amt > currentUser.balance) return showToast("Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØªØ¬Ø§ÙˆØ² Ø±ØµÙŠØ¯Ùƒ");

            await addDoc(collection(db, "withdrawals"), {
                userId: userDocId,
                userName: currentUser.name,
                amount: amt,
                status: 'pending',
                timestamp: serverTimestamp()
            });
            showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©");
            document.getElementById('withdrawAmt').value = '';
        };

        window.openTab = (id, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        };

        window.logout = () => {
            localStorage.removeItem('tajer_uid');
            location.reload();
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>